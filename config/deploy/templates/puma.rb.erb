#!/usr/bin/env puma

# Puma configuration file for production deployment
# Generated by Capistrano deployment

# Application directory
directory '<%= current_path %>'
rackup '<%= current_path %>/config.ru'

# Environment
environment 'production'

# Logging
stdout_redirect '<%= shared_path %>/log/puma.stdout.log', '<%= shared_path %>/log/puma.stderr.log', true

# Process options
daemonize true
pidfile '<%= shared_path %>/tmp/pids/puma.pid'
state_path '<%= shared_path %>/tmp/pids/puma.state'

# Socket
bind 'unix://<%= shared_path %>/tmp/sockets/puma.sock'

# Worker processes
workers <%= fetch(:puma_workers, 2) %>
threads <%= fetch(:puma_threads, [2, 16]).join(',') %>

# Preload application
preload_app!

# Restart command
restart_command 'bundle exec puma'

# Allow puma to be restarted by `rails restart` command
plugin :tmp_restart

on_worker_boot do
  # Worker specific setup for Rails 4.1+
  # See: https://devcenter.heroku.com/articles/deploying-rails-applications-with-the-puma-web-server#on-worker-boot
  ActiveRecord::Base.establish_connection if defined?(ActiveRecord)
end

before_fork do
  ActiveRecord::Base.connection_pool.disconnect! if defined?(ActiveRecord)
end