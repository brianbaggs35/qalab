<% content_for :title, "System Admin - Users" %>

<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-primary">User Management</h1>
      <p class="text-base-content/70 mt-1">Manage all users in the QA Lab platform</p>
    </div>
    <div class="flex gap-2">
      <%= link_to new_system_admin_user_path, 
          class: "btn btn-primary gap-2" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        New User
      <% end %>
      
      <%= link_to invite_organization_owner_system_admin_users_path, 
          class: "btn btn-secondary gap-2" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
        </svg>
        Invite Organization Owner
      <% end %>
      
      <%= link_to system_admin_dashboard_path, 
          class: "btn btn-ghost gap-2" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2H5a2 2 0 00-2 2z" />
        </svg>
        Dashboard
      <% end %>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="grid grid-cols-2 md:grid-cols-6 gap-4">
    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197m13.5-9a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0z" />
        </svg>
      </div>
      <div class="stat-title">Total Users</div>
      <div class="stat-value text-primary"><%= @stats[:total] %></div>
    </div>

    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
        </svg>
      </div>
      <div class="stat-title">System Admins</div>
      <div class="stat-value text-warning"><%= @stats[:system_admins] %></div>
    </div>

    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-info">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      </div>
      <div class="stat-title">Regular Users</div>
      <div class="stat-value text-info"><%= @stats[:regular_users] %></div>
    </div>

    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="stat-title">Confirmed</div>
      <div class="stat-value text-success"><%= @stats[:confirmed] %></div>
    </div>

    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-error">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
        </svg>
      </div>
      <div class="stat-title">Unconfirmed</div>
      <div class="stat-value text-error"><%= @stats[:unconfirmed] %></div>
    </div>

    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-neutral">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      <div class="stat-title">Locked</div>
      <div class="stat-value text-neutral"><%= @stats[:locked] %></div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card bg-base-100 shadow-sm">
    <div class="card-body">
      <%= form_with url: system_admin_users_path, method: :get, local: true, class: "flex flex-col lg:flex-row gap-4 items-end" do |form| %>
        <div class="form-control flex-1">
          <label class="label">
            <span class="label-text">Search Users</span>
          </label>
          <%= form.text_field :search, 
              value: params[:search], 
              class: "input input-bordered", 
              placeholder: "Search by name or email..." %>
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text">Role</span>
          </label>
          <%= form.select :role, 
              options_for_select([
                ['All Roles', ''],
                ['System Admin', 'system_admin'],
                ['Member', 'member']
              ], params[:role]), 
              {}, 
              { class: "select select-bordered" } %>
        </div>
        
        <div class="flex gap-2">
          <%= form.submit "Filter", class: "btn btn-primary" %>
          <%= link_to "Clear", system_admin_users_path, class: "btn btn-ghost" %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Users Table -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="flex items-center justify-between mb-4">
        <h2 class="card-title text-xl">Users</h2>
        <div class="text-sm text-base-content/60">
          Showing <%= @users.size %> of <%= @stats[:total] %> users
        </div>
      </div>

      <% if @users.any? %>
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>User</th>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Organizations</th>
                <th>Last Sign In</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @users.each do |user| %>
                <tr>
                  <td>
                    <div class="flex items-center gap-3">
                      <div class="avatar placeholder">
                        <div class="bg-neutral text-neutral-content rounded-full w-12">
                          <span class="text-sm font-bold"><%= user.first_name&.first %><%= user.last_name&.first %></span>
                        </div>
                      </div>
                      <div>
                        <div class="font-bold"><%= user.full_name %></div>
                        <div class="text-sm opacity-50">ID: <%= user.id.first(8) %>...</div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <%= user.email %>
                    <% if user.unconfirmed_email.present? %>
                      <div class="text-sm text-warning">
                        Pending: <%= user.unconfirmed_email %>
                      </div>
                    <% end %>
                  </td>
                  <td>
                    <% if user.system_admin? %>
                      <div class="badge badge-warning gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                        </svg>
                        System Admin
                      </div>
                    <% else %>
                      <div class="badge badge-info">Member</div>
                    <% end %>
                  </td>
                  <td>
                    <div class="flex flex-col gap-1">
                      <% if user.confirmed? %>
                        <div class="badge badge-success badge-sm">Confirmed</div>
                      <% else %>
                        <div class="badge badge-error badge-sm">Unconfirmed</div>
                      <% end %>
                      
                      <% if user.access_locked? %>
                        <div class="badge badge-warning badge-sm">Locked</div>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <div class="flex flex-wrap gap-1">
                      <% user.organizations.limit(3).each do |org| %>
                        <div class="badge badge-outline badge-sm">
                          <%= truncate(org.name, length: 15) %>
                        </div>
                      <% end %>
                      <% if user.organizations.count > 3 %>
                        <div class="badge badge-neutral badge-sm">
                          +<%= user.organizations.count - 3 %>
                        </div>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <% if user.last_sign_in_at %>
                      <%= time_ago_in_words(user.last_sign_in_at) %> ago
                    <% else %>
                      <span class="text-base-content/50">Never</span>
                    <% end %>
                  </td>
                  <td>
                    <div class="flex gap-1">
                      <%= link_to system_admin_user_path(user), 
                          class: "btn btn-ghost btn-sm", title: "View" do %>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                        </svg>
                      <% end %>
                      
                      <%= link_to edit_system_admin_user_path(user), 
                          class: "btn btn-ghost btn-sm", title: "Edit" do %>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                        </svg>
                      <% end %>
                      
                      <% unless user == current_user %>
                        <div class="dropdown dropdown-end">
                          <div tabindex="0" role="button" class="btn btn-ghost btn-sm">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01" />
                            </svg>
                          </div>
                          <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-52 z-10">
                            <% if user.access_locked? %>
                              <li>
                                <%= link_to unlock_system_admin_user_path(user), method: :patch, class: "text-success" do %>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                                  </svg>
                                  Unlock Account
                                <% end %>
                              </li>
                            <% else %>
                              <li>
                                <%= link_to lock_system_admin_user_path(user), method: :patch, class: "text-warning" do %>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                  </svg>
                                  Lock Account
                                <% end %>
                              </li>
                            <% end %>
                            
                            <% unless user.confirmed? %>
                              <li>
                                <%= link_to confirm_system_admin_user_path(user), method: :patch do %>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                  </svg>
                                  Confirm Account
                                <% end %>
                              </li>
                              <li>
                                <%= link_to resend_confirmation_system_admin_user_path(user), method: :patch do %>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 4.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                                  </svg>
                                  Resend Confirmation
                                <% end %>
                              </li>
                            <% end %>
                            
                            <div class="divider"></div>
                            <li>
                              <%= link_to system_admin_user_path(user), 
                                  method: :delete,
                                  class: "text-error",
                                  confirm: "Are you sure you want to delete '#{user.full_name}'? This action cannot be undone." do %>
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                                Delete User
                              <% end %>
                            </li>
                          </ul>
                        </div>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if @users.respond_to?(:current_page) && @users.total_pages > 1 %>
          <div class="flex justify-center mt-6">
            <%= paginate @users %>
          </div>
        <% end %>
      <% else %>
        <div class="text-center py-16">
          <div class="text-6xl mb-4">👥</div>
          <h3 class="text-xl font-semibold text-base-content/80 mb-2">No Users Found</h3>
          <p class="text-base-content/60 mb-6">No users match the current filters</p>
          <%= link_to new_system_admin_user_path, 
              class: "btn btn-primary gap-2" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Create First User
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>