<% content_for :title, "System Logs" %>

<div class="space-y-6">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <div>
      <h1 class="text-3xl font-bold text-primary flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        System Logs
      </h1>
      <p class="text-base-content/70 mt-2">
        View and monitor system logs for debugging and maintenance
      </p>
    </div>
    <div class="flex gap-3">
      <%= link_to system_admin_dashboard_path, class: "btn btn-ghost" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to Dashboard
      <% end %>
    </div>
  </div>

  <!-- Log Selection and Controls -->
  <div class="card bg-base-100 shadow-lg">
    <div class="card-body">
      <%= form_with url: system_admin_logs_path, method: :get, local: true, class: "flex flex-wrap gap-4 items-end" do |f| %>
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Log File</span>
          </label>
          <%= f.select :log, 
                       options_for_select(@log_files.map { |log| [log[:name], log[:name]] }, @selected_log),
                       {},
                       { class: "select select-bordered w-48" } %>
        </div>
        
        <div class="form-control">
          <label class="label">
            <span class="label-text font-semibold">Lines to Show</span>
          </label>
          <%= f.select :lines,
                       options_for_select([
                         ['Last 50 lines', 50],
                         ['Last 100 lines', 100],
                         ['Last 200 lines', 200],
                         ['Last 500 lines', 500],
                         ['Last 1000 lines', 1000]
                       ], @lines_to_show),
                       {},
                       { class: "select select-bordered w-40" } %>
        </div>
        
        <div class="form-control">
          <%= f.submit "Refresh", class: "btn btn-primary" %>
        </div>
        
        <div class="form-control">
          <%= link_to system_admin_logs_path(log: @selected_log, lines: @lines_to_show), 
                      class: "btn btn-secondary",
                      data: { turbo: false } do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Auto-refresh
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Log Statistics -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="stat bg-base-100 shadow-lg rounded-lg border-l-4 border-l-info">
      <div class="stat-figure text-info">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
      </div>
      <div class="stat-title">Current Log</div>
      <div class="stat-value text-info text-lg"><%= @selected_log %></div>
      <div class="stat-desc">Selected log file</div>
    </div>

    <div class="stat bg-base-100 shadow-lg rounded-lg border-l-4 border-l-secondary">
      <div class="stat-figure text-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z" />
        </svg>
      </div>
      <div class="stat-title">Total Lines</div>
      <div class="stat-value text-secondary"><%= number_with_delimiter(@total_lines) %></div>
      <div class="stat-desc">In the log file</div>
    </div>

    <div class="stat bg-base-100 shadow-lg rounded-lg border-l-4 border-l-accent">
      <div class="stat-figure text-accent">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
        </svg>
      </div>
      <div class="stat-title">Showing</div>
      <div class="stat-value text-accent"><%= @lines_to_show %></div>
      <div class="stat-desc">Most recent lines</div>
    </div>
  </div>

  <!-- Log Content -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="flex justify-between items-center mb-4">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Log Output
        </h2>
        
        <div class="flex gap-2">
          <button onclick="copyLogContent()" class="btn btn-sm btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
            </svg>
            Copy
          </button>
          
          <button onclick="downloadLogContent()" class="btn btn-sm btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z" />
            </svg>
            Download
          </button>
        </div>
      </div>
      
      <div class="bg-base-300 rounded-lg p-4 max-h-96 overflow-auto">
        <pre id="log-content" class="text-xs leading-relaxed whitespace-pre-wrap font-mono text-base-content"><%= @log_content %></pre>
      </div>
      
      <% if @total_lines > @lines_to_show %>
        <div class="alert alert-info mt-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <span>
            Showing the last <%= @lines_to_show %> lines of <%= number_with_delimiter(@total_lines) %> total lines.
            <%= link_to "Show more lines", system_admin_logs_path(log: @selected_log, lines: [@lines_to_show * 2, 5000].min), 
                        class: "link link-primary font-semibold" %>
          </span>
        </div>
      <% end %>
    </div>
  </div>

  <!-- Log Analysis -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h3 class="card-title text-warning">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16.5c-.77.833.192 2.5 1.732 2.5z" />
          </svg>
          Quick Analysis
        </h3>
        
        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <span>Error lines</span>
            <span class="badge badge-error"><%= @log_content.scan(/ERROR/i).count %></span>
          </div>
          <div class="flex justify-between">
            <span>Warning lines</span>
            <span class="badge badge-warning"><%= @log_content.scan(/WARN/i).count %></span>
          </div>
          <div class="flex justify-between">
            <span>Info lines</span>
            <span class="badge badge-info"><%= @log_content.scan(/INFO/i).count %></span>
          </div>
          <div class="flex justify-between">
            <span>Total lines shown</span>
            <span class="badge badge-ghost"><%= @log_content.lines.count %></span>
          </div>
        </div>
      </div>
    </div>

    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h3 class="card-title text-info">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Log Files Available
        </h3>
        
        <div class="space-y-2">
          <% @log_files.each do |log_file| %>
            <div class="flex justify-between items-center">
              <span class="text-sm <%= 'font-semibold' if log_file[:name] == @selected_log %>">
                <%= log_file[:name] %>
              </span>
              <div>
                <% if File.exist?(log_file[:path]) %>
                  <span class="badge badge-success badge-sm">Available</span>
                  <span class="text-xs text-base-content/60 ml-2">
                    <%= number_to_human_size(File.size(log_file[:path])) %>
                  </span>
                <% else %>
                  <span class="badge badge-error badge-sm">Missing</span>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function copyLogContent() {
  const logContent = document.getElementById('log-content').textContent;
  navigator.clipboard.writeText(logContent).then(() => {
    // Show success message
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
    </svg>Copied!`;
    setTimeout(() => {
      btn.innerHTML = originalText;
    }, 2000);
  });
}

function downloadLogContent() {
  const logContent = document.getElementById('log-content').textContent;
  const blob = new Blob([logContent], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `<%= @selected_log %>_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.log`;
  document.body.appendChild(a);
  a.click();
  window.URL.revokeObjectURL(url);
  document.body.removeChild(a);
}

// Auto-refresh functionality
<% if params[:refresh] == 'true' %>
setTimeout(() => {
  window.location.reload();
}, 30000); // Refresh every 30 seconds
<% end %>
</script>