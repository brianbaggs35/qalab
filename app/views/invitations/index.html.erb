<% content_for :title, "Manage Invitations" %>
<% content_for :breadcrumbs do %>
  <li>Organization</li>
  <li class="text-primary font-semibold">Invitations</li>
<% end %>

<div class="space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-3xl font-bold text-primary">Manage Invitations</h1>
      <p class="text-base-content/70 mt-1">Invite new members to <%= @organization&.name || 'your organization' %></p>
    </div>
    <div class="flex gap-2">
      <%= link_to new_invitation_path, class: "btn btn-primary gap-2" do %>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Send Invitation
      <% end %>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
        </svg>
      </div>
      <div class="stat-title">Total Invitations</div>
      <div class="stat-value text-primary"><%= @invitations.total_count if @invitations.respond_to?(:total_count) %></div>
      <div class="stat-desc">All time</div>
    </div>

    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-warning">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="stat-title">Pending</div>
      <div class="stat-value text-warning"><%= @invitations.select(&:valid_invitation?).count %></div>
      <div class="stat-desc">Awaiting acceptance</div>
    </div>

    <div class="stat bg-base-100 shadow-sm rounded-lg">
      <div class="stat-figure text-success">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </div>
      <div class="stat-title">Accepted</div>
      <div class="stat-value text-success"><%= @invitations.select(&:accepted?).count %></div>
      <div class="stat-desc">Successfully joined</div>
    </div>
  </div>

  <!-- Invitations Table -->
  <div class="card bg-base-100 shadow-xl">
    <div class="card-body">
      <div class="flex items-center justify-between mb-4">
        <h2 class="card-title text-xl">Recent Invitations</h2>
        <div class="text-sm text-base-content/60">
          <% if @invitations.any? %>
            Showing <%= @invitations.offset_value + 1 if @invitations.respond_to?(:offset_value) %>-<%= @invitations.length %> of <%= @invitations.total_count if @invitations.respond_to?(:total_count) %> invitations
          <% else %>
            No invitations sent yet
          <% end %>
        </div>
      </div>

      <% if @invitations.any? %>
        <div class="overflow-x-auto">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Email</th>
                <th>Role</th>
                <th>Status</th>
                <th>Invited By</th>
                <th>Sent</th>
                <th>Expires</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <% @invitations.each do |invitation| %>
                <tr class="hover">
                  <td>
                    <div class="flex items-center gap-3">
                      <div class="avatar placeholder">
                        <div class="bg-neutral text-neutral-content rounded-full w-8 h-8">
                          <span class="text-xs"><%= invitation.email[0].upcase %></span>
                        </div>
                      </div>
                      <div>
                        <div class="font-semibold"><%= invitation.email %></div>
                      </div>
                    </div>
                  </td>
                  <td>
                    <% case invitation.role %>
                    <% when 'owner' %>
                      <div class="badge badge-error">Owner</div>
                    <% when 'admin' %>
                      <div class="badge badge-warning">Admin</div>
                    <% when 'member' %>
                      <div class="badge badge-info">Member</div>
                    <% end %>
                  </td>
                  <td>
                    <% if invitation.accepted? %>
                      <div class="flex items-center gap-2">
                        <div class="badge badge-success">Accepted</div>
                        <span class="text-xs text-base-content/60"><%= time_ago_in_words(invitation.accepted_at) %> ago</span>
                      </div>
                    <% elsif invitation.expired? %>
                      <div class="badge badge-error">Expired</div>
                    <% else %>
                      <div class="badge badge-warning">Pending</div>
                    <% end %>
                  </td>
                  <td>
                    <div class="text-sm">
                      <div class="font-medium"><%= invitation.invited_by.first_name %> <%= invitation.invited_by.last_name %></div>
                      <div class="text-base-content/70"><%= invitation.invited_by.email %></div>
                    </div>
                  </td>
                  <td>
                    <div class="text-sm">
                      <div class="font-medium"><%= invitation.created_at.strftime('%b %d, %Y') %></div>
                      <div class="text-base-content/70"><%= invitation.created_at.strftime('%I:%M %p') %></div>
                    </div>
                  </td>
                  <td>
                    <div class="text-sm">
                      <% if invitation.expired? %>
                        <span class="text-error">Expired</span>
                      <% elsif invitation.accepted? %>
                        <span class="text-base-content/50">N/A</span>
                      <% else %>
                        <div class="font-medium"><%= invitation.expires_at.strftime('%b %d, %Y') %></div>
                        <div class="text-base-content/70">
                          <%= distance_of_time_in_words(Time.current, invitation.expires_at) %> remaining
                        </div>
                      <% end %>
                    </div>
                  </td>
                  <td>
                    <div class="flex gap-2">
                      <% unless invitation.accepted? %>
                        <button class="btn btn-ghost btn-xs" onclick="copyInvitationLink('<%= accept_invitation_url(token: invitation.token) %>')">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                          </svg>
                        </button>
                        
                        <%= link_to invitation_path(invitation), method: :delete,
                            confirm: "Are you sure you want to cancel this invitation?",
                            class: "btn btn-ghost btn-error btn-xs" do %>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                          </svg>
                        <% end %>
                      <% else %>
                        <span class="text-base-content/50 text-xs">Accepted</span>
                      <% end %>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <% if @invitations.respond_to?(:total_pages) && @invitations.total_pages > 1 %>
          <div class="flex justify-center mt-6">
            <%= paginate @invitations, theme: 'twitter_bootstrap_4' %>
          </div>
        <% end %>
      <% else %>
        <!-- Empty State -->
        <div class="text-center py-16">
          <div class="text-6xl mb-4">ðŸ‘¥</div>
          <h3 class="text-xl font-semibold text-base-content/80 mb-2">No Invitations Sent Yet</h3>
          <p class="text-base-content/60 mb-6">Start building your team by sending your first invitation</p>
          <%= link_to new_invitation_path, class: "btn btn-primary gap-2" do %>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
            </svg>
            Send Your First Invitation
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  function copyInvitationLink(url) {
    navigator.clipboard.writeText(url).then(function() {
      // You could show a toast notification here
      alert('Invitation link copied to clipboard!');
    }, function(err) {
      console.error('Could not copy invitation link: ', err);
      alert('Failed to copy invitation link');
    });
  }
</script>
